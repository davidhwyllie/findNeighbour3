<html>

<head>
    <title>Cluster visualisation</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.2.18/cytoscape.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
 
    <script>
        console.log("startup");
    </script>
    <style>
        #cy {
            width: 1000px;
            height: 800px;
            display: block;
        }

    </style>

</head>
<body>
 <div class="demo">
 

         <p><label for="cpname">For</label> <select name="cpname" id="cpname">
            
        </select>
        <label for="cluster_lbl">and cluster</label> <input id="cluster_id" type='number' name="value" value="1">
        <button id="doDepictionNetwork" >Show Network</button>
        <button id="doDepictionMST" >Show Min.Spanning Tree</button>
        <button id="doDepictionMSA" >Show Multi sequence alignment</button>
        <button id="doDepictionFasta" >Show Multi sequence fasta</button>
         </p>
        <p>
        <button id="addLabels" name="addLabels">Add cluster identifiers from clustering strategy</button> 
        <label for="annotname"></label> <select name="annotname" id="annotname">
        </p>
        
        </select>
        <p>
        <button id="removeLabels" name="removeLabels">Remove cluster identifiers</button> 
        </p>
        <p> 
        <button id="downloadJson" >Download JSON</button>
        <button id="downloadPng" >Download PNG</button>
        <button id="downloadMSA" >Download MSA</button>
        <button id="downloadFasta" >Download Fasta</button>
        </p>
        <span id="usingFontSize">Adjust label size</span> 
                 <input type="range" min="1" max="10" value="2" class="slider" id="csFontSize">

        <span id="usingNodeSize">node size</span> 
                 <input type="range" min="1" max="10" value="2" class="slider" id="csNodeSize">
        </p>
        <p>    <div id="cy_title"></div>
        <div id="mousePsn"><span id="recentNode">-</span></div>
        <div id="cy"></div>

        

<script>
// layout options
var baseurl = "http://127.0.0.1:5020/api/v2/";

var options = {
    name: 'cose',

    // Called on `layoutready`
    ready: function() {},

    // Called on `layoutstop`
    stop: function() {},

    // Whether to animate while running the layout
    // true : Animate continuously as the layout is running
    // false : Just show the end result
    // 'end' : Animate with the end result, from the initial positions to the end positions
    animate: true,

    // Easing of the animation for animate:'end'
    animationEasing: undefined,

    // The duration of the animation for animate:'end'
    animationDuration: undefined,

    // A function that determines whether the node should be animated
    // All nodes animated by default on animate enabled
    // Non-animated nodes are positioned immediately when the layout starts
    animateFilter: function(node, i) {
        return true;
    },


    // The layout animates only after this many milliseconds for animate:true
    // (prevents flashing on fast runs)
    animationThreshold: 250,

    // Number of iterations between consecutive screen positions update
    // (0 -> only updated on the end)
    refresh: 20,

    // Whether to fit the network view after when done
    fit: true,

    // Padding on fit
    padding: 30,

    // Constrain layout bounds; { x1, y1, x2, y2 } or { x1, y1, w, h }
    boundingBox: undefined,

    // Excludes the label when calculating node bounding boxes for the layout algorithm
    nodeDimensionsIncludeLabels: false,

    // Randomize the initial positions of the nodes (true) or use existing positions (false)
    randomize: false,

    // Extra spacing between components in non-compound graphs
    componentSpacing: 40,

    // Node repulsion (non overlapping) multiplier
    nodeRepulsion: function(node) {
        return 2048;
    },

    // Node repulsion (overlapping) multiplier
    nodeOverlap: 4,

    // Ideal edge (non nested) length
    idealEdgeLength: function(edge) {
        return edge.data().snv+0.5;
    },

    // Divisor to compute edge forces
    edgeElasticity: function(edge) {
        return 10;
        //return Math.sqrt(edge.data().snv+1);
    },

    // Nesting factor (multiplier) to compute ideal edge length for nested edges
    nestingFactor: 1.2,

    // Gravity force (constant)
    gravity: 1,

    // Maximum number of iterations to perform
    numIter: 1000,

    // Initial temperature (maximum node displacement)
    initialTemp: 1000,

    // Cooling factor (how the temperature is reduced between consecutive iterations
    coolingFactor: 0.99,

    // Lower temperature threshold (below this point the layout will end)
    minTemp: 1.0,

    // Pass a reference to weaver to use threads for calculations
    weaver: false
};
function offerReloadPage(msg){
     var btn = document.createElement("BUTTON");        // Create a <button> element
     var t = document.createTextNode("Click to reload page");
     btn.appendChild(t);
     btn.onclick = function(){
       location.reload();
     };
     
     document.getElementById('cy_title').innerHTML = msg;
     document.getElementById('cy_title').appendChild(btn);
}
function getPipelines() {
    $.ajax({
        type: "GET",
        url: baseurl + "clustering",
        success: function(data) {
            buildDropdown(JSON.parse(data), $('#annotname'));
            buildDropdown(JSON.parse(data), $('#cpname'));

            $("#cpname").show();
            $("#cluster_id").show();
            $("#cluster_lbl").show();
            $("#doDepictionNetwork").show();
            $("#doDepictionMST").show();
            $("#doDepictionMSA").show();
            $("#doDepictionFasta").show();
        },
        fail: function(xmlHttpRequest, textStatus) {
             alert(textStatus);
        },
        error:function ( xmlHttpRequest, textStatus, errorThrown) {

             var msg = "Failed to connect to findNeighbour3 server on "+baseurl+"("+textStatus+"-"+ errorThrown+").  Check the server is operational.";
             offerReloadPage(msg);
        }
    });
}

function buildDropdown(result, dropdown) {
    // builds a dropdown from the 'algorithms' (a list) property of 'result'
    // Remove current options
    dropdown.html('');
    if (result != '') {
        // Loop through each of the results and append the option to the dropdown
        console.log(result);
        for (i = 0; i < result.algorithms.length; i++) {
            dropdown.append('<option value="' + result.algorithms[i] + '">' + result.algorithms[i] + '</option>');
        }
    }
}
function depict_msa(msa_format) {
    var network_name = $("#cpname").val() + "/" + $("#cluster_id").val();
    
    if (['html','fasta'].indexOf(msa_format)>=0){
     document.getElementById('cy_title').innerHTML = network_name;
     document.getElementById('cy').innerHTML = "-- data for MSA of " + network_name + " is loading --";
 
     var url1 = baseurl + "multiple_alignment_cluster/" + network_name + "/" + msa_format;
     
     // check validity of network_type
     $.get(url1, {}, function(data) {
           document.getElementById('cy').innerHTML = "";
           console.log(url1);
           if (msa_format=='html'){
               document.getElementById('cy').innerHTML = data;
               $("#downloadMSA").show();
               $("#downloadFasta").hide();
           } else {
            var fasta = document.createElement('TEXTAREA');
            fasta.setAttribute('id', 'fasta');
            fasta.setAttribute('name', 'fasta');
            fasta.setAttribute('cols',200);
            fasta.setAttribute('rows', 40);
            fasta.value = data;
            document.getElementById('cy').appendChild(fasta);
            $("#downloadFasta").show();
            $("#downloadMSA").hide();
           }
           $("#downloadPng").hide();
           $("#downloadJson").hide();
           $("#addLabels").hide();
           $("#removeLabels").hide();
           $("#annotname").hide();
           set_visibility_size_control_elements('hide');
       });
    } else {
          document.getElementById('cy_title').innerHTML = "Invalid request for a "+msa_format;     
    }
}

function depict_network(network_type) {
    var network_name = $("#cpname").val() + "/" + $("#cluster_id").val();
    document.getElementById('cy_title').innerHTML = network_name;
    document.getElementById('cy').innerHTML = "-- data for " + network_name + " is loading --";

    var url1 = baseurl + "clustering/" + network_name + "/" + network_type;
    // check validity of network_type
    if (['network','minimum_spanning_tree'].indexOf(network_type)>=0){
      $.getJSON(url1, {}, function(data) {
          document.getElementById('cy').innerHTML = "";
          console.log(url1);
          generate_cytoscape_object(
              container = document.getElementById('cy'),
              data = data);
          
          // now there is a network in place, we can do things with it;
          document.getElementById('cy_title').innerHTML = data.message;
          $("#downloadPng").show();
          $("#downloadJson").show();
          $("#downloadFasta").hide();
          $("#downloadMSA").hide();
          $("#addLabels").show();
          $("#removeLabels").show();
          $("#annotname").show();
          set_visibility_size_control_elements('show');
      });
    } else {
          document.getElementById('cy_title').innerHTML = "Invalid request for a "+network_type;
    }
}
function set_visibility_size_control_elements(action) {
      if (action == 'show'){
        $("#csFontSize").show();
        $("#csNodeSize").show();
        $("#usingNodeSize").show();
        $("#usingFontSize").show();
      } else {
        $("#csFontSize").hide();
        $("#csNodeSize").hide();
        $("#usingNodeSize").hide();
        $("#usingFontSize").hide();      
       
      }
}
function add_labels() {
    // display node labels
    var chosenFontSize = $("#csFontSize").val();
    var url2 = baseurl + "clustering/" + $("#annotname").val() + "/guids2clusters";
    var g2c = $.getJSON(url2, {}, function(g2c_list) {

        // update node properties
        l = g2c_list.length;
        for (var i = 0; i < l; i++) {
            var item = g2c_list[i];
            cy.$("#" + item.guid).css({
                "font-size": chosenFontSize,
                "content": item.cluster_id
            });
        }
    });
}

function remove_labels() {
    // display node labels
        cy.$("node").css({
        "content":""
        });
      }

function resize_nodes() {
    // resize nodes
    var chosenNodeSize = $("#csNodeSize").val();
    cy.$("node").css({
        "width": chosenNodeSize + "px",
        "height": chosenNodeSize + "px"
    });

}
function resize_labels() {
    // resize nodes
    var chosenFontSize = $("#csFontSize").val();

    cy.$("node").css({
        "font-size": chosenFontSize,
    });
}

function generate_cytoscape_object(container, data) {

    custom_style = [{
            selector: 'node[is_mixed=0]',
            style: {
                'background-color': 'blue'
            }
        }, {
            selector: 'node[is_mixed=1]',
            style: {

                'background-color': 'red'
            }
        }, {
            selector: 'node[picked=1]',
            style: {
                'width': '5px',
                'height': '5px',
                'background-fit': 'contain',
                'background-clip': 'none'
            },
                   
        }, {
            selector: 'node[picked=0]',
            style: {
                'shape': 'diamond',
                'width': '5px',
                'height': '5px',
                'background-fit': 'contain',
                'background-clip': 'none'
            },         
        },{
            selector: 'edge',
            style: {
                'text-background-color': 'yellow',
                'text-background-opacity': 0.4,
                'width': '0.5px',
                'target-arrow-shape': 'triangle',
                'control-point-step-size': '140px'
            }
        }
    ];


    cy = cytoscape({
        container: container,
        elements: data.elements,
        style: custom_style,
        layout:  options        
    });

    cy.$("node").data("picked",0);  // nothing selected
    cy.on('mouseover', 'node', function(event) {
        document.getElementById('recentNode').innerHTML = event.target.id();
    });
        cy.on('mouseout', 'node', function(event) {
        document.getElementById('recentNode').innerHTML = '-';
    });
    cy.on('mouseover', 'edge', function(event) {
        // var node = event.cyTarget;

        var id = event.target.id();
        var edata = cy.$("#"+id).data();
        var edescr = edata.snv+' snv ['+edata.source+'-----'+edata.target+']';
        document.getElementById('recentNode').innerHTML = edescr;
    });
        cy.on('mouseout', 'edge', function(event) {
        document.getElementById('recentNode').innerHTML = '-';
    });
    cy.on('click', 'node', function(event) {
        // var node = event.cyTarget;
        var id = event.target.id();
        if (cy.$("#"+id).data("picked")==0) {
        cy.$("#"+id).data("picked",1);
        document.getElementById('recentNode').innerHTML = event.target.id()+" Selected";
        } else {
        cy.$("#"+id).data("picked",0);        
        document.getElementById('recentNode').innerHTML = event.target.id()+" Deselected";
        }

    });
}


function download(filename, payload) {
    var element = document.createElement('a');
    element.setAttribute('href', 'data:' + payload);
    element.setAttribute('download', filename);
    element.style.display = 'none';
    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);
}
$("#downloadPng").click(function() {
    filestem = $("#cpname").val() + "_" + $("#cluster_id").val();
    payload = cy.png();
    download(filestem + ".png", payload);

});

$("#downloadJson").click(function() {
    filestem = $("#cpname").val() + "_" + $("#cluster_id").val();
    payload = "application/json;charset=utf-8," + encodeURIComponent(JSON.stringify(cy.json()));
    download(filestem + ".json", payload);
});
$("#downloadMSA").click(function() {
    filestem = $("#cpname").val() + "_" + $("#cluster_id").val();
    payload = "text/html;charset=utf-8," + $("#cy").html();
    download(filestem + ".html", payload);
});
$("#downloadFasta").click(function() {
    filestem = $("#cpname").val() + "_" + $("#cluster_id").val();
    payload = "text/plain;charset=utf-8," + encodeURIComponent($('#fasta').val());
    download(filestem + ".fasta", payload);
});
$("#doDepictionNetwork").click(function() {
    depict_network('network');
});
$("#doDepictionMST").click(function() {
    depict_network('minimum_spanning_tree');
});
$("#doDepictionMSA").click(function() {
    depict_msa('html');
});
$("#doDepictionFasta").click(function() {
    depict_msa('fasta');
});
$("#addLabels").click(function() {
    add_labels();
});
$("#removeLabels").click(function() {
    remove_labels();
});
$("#csFontSize").change(function() {
    resize_labels();
});
$("#csNodeSize").change(function() {
    resize_nodes();
});


// any extra code here
$(document).ready(function(e) {
    getPipelines();
    // hide buttons which aren't relevant until network loads
    $("#cpname").hide();
    $("#doDepictionMST").hide();
    $("#doDepictionMSA").hide();
    $("#doDepictionFasta").hide();
    $("#doDepictionNetwork").hide();
    $("#downloadPng").hide();
    $("#downloadJson").hide();
    $("#downloadFasta").hide();
    $("#downloadMSA").hide();
    $("#addLabels").hide();
    $("#removeLabels").hide();
    $("#annotname").hide();
    $("#csFontSize").hide();
    $("#csNodeSize").hide();
    $("#usingNodeSize").hide();
    $("#usingFontSize").hide();
    $("#cluster_id").hide();
    $("#cluster_lbl").hide();
});
</script>
</body>

</html>
